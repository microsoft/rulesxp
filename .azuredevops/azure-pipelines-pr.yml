# PR validation pipeline for microsoft/rulesxp
# - Triggered on GitHub pull requests targeting main
# - Annotates the build name with PR metadata so ADO has access to this info.

trigger: none

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

steps:
  - powershell: |
      Write-Host "Build.Reason: $env:BUILD_REASON"
      Write-Host "PR number (GitHub): $env:SYSTEM_PULLREQUEST_PULLREQUESTNUMBER"
      Write-Host "From (source branch): $env:SYSTEM_PULLREQUEST_SOURCEBRANCH"
      Write-Host "To   (target branch): $env:SYSTEM_PULLREQUEST_TARGETBRANCH"
      Write-Host "Repo: $env:BUILD_REPOSITORY_NAME"

      # Compose a concise build name for email subjects / UI
      $prId = if ($env:SYSTEM_PULLREQUEST_PULLREQUESTNUMBER) { $env:SYSTEM_PULLREQUEST_PULLREQUESTNUMBER } else { 'none' }

      # Start from the commit message, truncate, then sanitize for build number rules
      $commitMsg = $env:BUILD_SOURCEVERSIONMESSAGE
      if (-not [string]::IsNullOrEmpty($commitMsg)) {
        if ($commitMsg.Length -gt 60) {
          $commitMsg = $commitMsg.Substring(0,60)
        }
        # Replace characters not allowed in build numbers
        $commitMsg = [regex]::Replace($commitMsg, '["\/:<>\\|?@*]', '_')
        $commitMsg = $commitMsg.Trim()
        if ($commitMsg.EndsWith('.')) {
          $commitMsg = $commitMsg.TrimEnd('.')
        }
      }

      $buildName = "PR $prId - $commitMsg"
      Write-Host "##vso[build.updatebuildnumber]$buildName"
    displayName: "Annotate build with PR metadata"
